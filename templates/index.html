{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl" x-data="timeTrackerApp()">

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold gradient-text mb-2">‚ú® TimeTracker</h1>
        <p class="text-gray-600 dark:text-gray-400">Today: {{ date }}</p>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column - Timer & Entry Form -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Active Timer Card -->
            {% if active_session %}
            <div class="card-gradient p-6 timer-pulse">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">‚è±Ô∏è Active Session</h2>
                    <div class="pulse-dot"></div>
                </div>
                <div id="timer-display" class="text-5xl font-mono gradient-text mb-4">00:00:00</div>
                <p class="text-lg mb-2">{{ active_session.task_name or 'Working...' }}</p>
                {% if active_session.project %}
                <span class="project-badge">{{ active_session.project }}</span>
                {% endif %}
                <button onclick="stopSession()" class="mt-4 w-full gradient-primary text-white px-6 py-3 rounded-lg hover:opacity-90 transition">
                    <i class="fas fa-stop-circle mr-2"></i> Stop Session
                </button>
            </div>
            {% else %}
            <!-- Start Session Card -->
            <div class="card-gradient p-6">
                <h2 class="text-xl font-semibold mb-4">‚ñ∂Ô∏è Start Work Session</h2>
                <form onsubmit="startSession(event)">
                    <input type="text" id="session-task" placeholder="Task name (optional)"
                           class="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 mb-3">
                    <input type="text" id="session-project" list="projects-list" placeholder="Project (optional)"
                           class="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 mb-4">
                    <button type="submit" class="w-full gradient-primary text-white px-6 py-3 rounded-lg hover:opacity-90 transition">
                        <i class="fas fa-play-circle mr-2"></i> Start Session
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Quick Entry Form -->
            <div class="card-gradient p-6">
                <h2 class="text-xl font-semibold mb-4">‚úçÔ∏è Add Manual Entry</h2>
                <form onsubmit="addEntry(event)">
                    <input type="text" id="entry-task" placeholder="Task name" required
                           class="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 mb-3">
                    <input type="text" id="entry-duration" placeholder="Duration (e.g., 2h 30m)" required
                           class="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 mb-3">
                    <input type="text" id="entry-project" list="projects-list" placeholder="Project (optional)"
                           class="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 mb-4">
                    <button type="submit" class="w-full bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition">
                        <i class="fas fa-plus-circle mr-2"></i> Add Entry
                    </button>
                </form>
            </div>

            <!-- Today's Work Log -->
            <div class="card-gradient p-6">
                <h2 class="text-xl font-semibold mb-4">üìù Today's Work Log</h2>
                <div class="space-y-3">
                    {% for session in sessions %}
                    {% if session.duration %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1">
                            <span class="text-sm text-gray-500"><i class="fas fa-clock mr-1"></i> Session</span>
                            <p class="font-medium">{{ session.task_name or 'Work session' }}</p>
                            {% if session.project %}
                            <span class="project-badge text-xs">{{ session.project }}</span>
                            {% endif %}
                            <p class="text-sm text-gray-600">{{ (session.duration / 60) | int }} min</p>
                        </div>
                        <button onclick="deleteItem('session', {{ session.id }})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endif %}
                    {% endfor %}

                    {% for entry in entries %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1">
                            <span class="text-sm text-gray-500"><i class="fas fa-pen mr-1"></i> Manual</span>
                            <p class="font-medium">{{ entry.task_name }}</p>
                            {% if entry.project %}
                            <span class="project-badge text-xs">{{ entry.project }}</span>
                            {% endif %}
                            <p class="text-sm text-gray-600">{{ (entry.duration / 60) | int }} min</p>
                        </div>
                        <button onclick="deleteItem('entry', {{ entry.id }})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    {% endfor %}

                    {% if not sessions and not entries %}
                    <p class="text-center text-gray-500 py-8">No entries yet. Start a session or add a manual entry!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column - Summary -->
        <div class="space-y-6">
            <!-- Daily Summary Card -->
            <div class="card-gradient p-6">
                <h2 class="text-xl font-semibold mb-4">üìä Daily Summary</h2>
                <div class="text-center mb-6">
                    <div class="text-5xl font-bold gradient-text mb-2">{{ summary.total_formatted }}</div>
                    <p class="text-gray-600 dark:text-gray-400">Total Work Time</p>
                </div>

                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Sessions:</span>
                        <span class="font-semibold">{{ summary.session_count }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Manual Entries:</span>
                        <span class="font-semibold">{{ summary.manual_entry_count }}</span>
                    </div>
                </div>

                {% if summary.tasks %}
                <div class="mt-6">
                    <h3 class="font-semibold mb-3">By Task:</h3>
                    {% for task in summary.tasks %}
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="truncate">{{ task.name }}</span>
                            <span class="font-medium">{{ task.duration_formatted }}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (task.duration / summary.total_duration * 100) | int }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Projects datalist -->
    <datalist id="projects-list">
        {% for project in projects %}
        <option value="{{ project }}">
        {% endfor %}
    </datalist>

</div>

<!-- Timer script -->
<script src="/static/js/timer.js"></script>

<script>
function timeTrackerApp() {
    return {
        init() {
            {% if active_session %}
            initTimer('{{ active_session.id }}', '{{ active_session.start_time }}');
            {% endif %}
        }
    }
}

async function startSession(e) {
    e.preventDefault();
    const task_name = document.getElementById('session-task').value;
    const project = document.getElementById('session-project').value;

    const response = await fetch('/api/sessions/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({task_name, project})
    });

    const data = await response.json();
    if (data.success) {
        location.reload();
    } else {
        alert(data.error);
    }
}

async function stopSession() {
    const response = await fetch('/api/sessions/stop', {method: 'POST'});
    const data = await response.json();
    if (data.success) {
        location.reload();
    }
}

async function addEntry(e) {
    e.preventDefault();
    const task_name = document.getElementById('entry-task').value;
    const duration_str = document.getElementById('entry-duration').value;
    const project = document.getElementById('entry-project').value;

    const response = await fetch('/api/entries', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({task_name, duration_str, project})
    });

    const data = await response.json();
    if (data.success) {
        location.reload();
    } else {
        alert(data.error);
    }
}

async function deleteItem(type, id) {
    if (!confirm('Are you sure you want to delete this item?')) return;

    const endpoint = type === 'session' ? `/api/sessions/${id}` : `/api/entries/${id}`;
    await fetch(endpoint, {method: 'DELETE'});
    location.reload();
}
</script>
{% endblock %}
